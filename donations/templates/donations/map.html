{% extends "donations/base.html" %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-gray-800">Donation Map</h2>

<div id="map" class="w-full h-[600px] rounded shadow"></div>

<!-- Pass items safely -->
{{ items|json_script:"items-data" }}

<script>
    const map = L.map('map').setView([20.5937, 78.9629], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Load items from JSON
    const items = JSON.parse(document.getElementById("items-data").textContent);
    const markers = [];

    items.forEach(item => {
        if (!item.latitude || !item.longitude) return;

        const marker = L.marker([item.latitude, item.longitude]).addTo(map);
        markers.push(marker);

        const detailUrl = `/items/${item.id}/`;

        // Clean popup WITHOUT "Request Item"
        const popupHTML = `
            <div style="width: 220px; font-family: sans-serif;">
                <div class="font-bold text-lg text-gray-900 mb-1">${item.title}</div>

                ${item.image ?
                    `<img src="${item.image}" class="w-full h-28 object-cover rounded mb-2 shadow-sm">`
                : ""
                }

                <div class="text-sm text-gray-700 mb-3">
                    <strong>Category:</strong> ${item.category}<br>
                    <strong>Condition:</strong> ${item.condition}<br>
                    <strong>Donor:</strong> ${item.donor_username}<br>
                </div>

                <a href="${detailUrl}" 
                   class="block bg-blue-600 text-white text-center px-3 py-1 rounded hover:bg-blue-700 transition">
                    View Details
                </a>
            </div>
        `;

        marker.bindPopup(popupHTML);
    });

    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.3));
    }
</script>

{% endblock %}
